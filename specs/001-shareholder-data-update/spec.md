# Feature Specification: 股東資料修正功能

**Feature Branch**: `001-shareholder-data-update`  
**Created**: 2025-12-18  
**Status**: Draft  
**Input**: User description: "請幫我寫一個股東資料修正的網頁產生功能規格:股東掃描個人的QRCODE後進入網頁，彈窗輸入身分證字號核對身分後，帶入個人相對應的資料，並提供地址及電話號碼的修改功能。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - QR Code 掃描、有效性檢查與身份驗證 (Priority: P1)

股東使用行動裝置掃描個人專屬的 QR Code（QR Code 內容為完整 URL，例如：`http://localhost:6230/shareholder/update/1234561`，其中 `123456` 為 6 位股東代號，`1` 為由股東代號計算產生的檢查碼，URL 中的識別碼為 7 位數字驗證碼），進入網頁後**系統先呼叫後端 API 檢查該 QR Code 是否存在且有效**：

- 若 QR Code 無效或資料庫中不存在 → 直接顯示「QR Code 無效或已過期」錯誤畫面（含聯繫管理員資訊），**不顯示身份驗證彈窗**
- 若 QR Code 有效 → 系統檢查該股東資料的手機號碼欄位（優先順序：`UPDATED_MOBILE_PHONE` → `ORIGINAL_MOBILE_PHONE`）：
  - **如果有手機號碼（任一欄位不為空）**：優先使用最新修改的手機號碼（`UPDATED_MOBILE_PHONE`），如果為空則使用原始手機號碼（`ORIGINAL_MOBILE_PHONE`）。系統自動產生 4 位數字驗證碼並發送簡訊至該手機號碼，顯示身份驗證彈窗要求輸入手機驗證碼
  - **如果兩個手機號碼欄位都為空**：顯示身份驗證彈窗要求輸入身分證末四碼
- 驗證成功後系統載入該股東的個人資料。

**Why this priority**: 身份驗證是整個功能的基礎，必須先確保股東身份正確才能進行後續的資料修改操作。這是安全性和資料正確性的核心保障。

**Independent Test**: 可以透過掃描 QR Code、輸入正確的驗證碼（手機驗證碼或身分證末四碼），驗證系統能夠正確識別股東身份並載入對應資料。此流程可獨立完成並提供價值（身份驗證功能）。

**Acceptance Scenarios**:

1. **Given** 股東持有個人專屬 QR Code 且資料中有手機號碼，**When** 使用行動裝置掃描 QR Code，**Then** 系統開啟網頁、自動發送驗證碼簡訊至手機號碼，並顯示身份驗證彈窗要求輸入手機驗證碼
2. **Given** 股東持有個人專屬 QR Code 且資料中沒有手機號碼，**When** 使用行動裝置掃描 QR Code，**Then** 系統開啟網頁並顯示身份驗證彈窗要求輸入身分證末四碼
3. **Given** QR Code 已通過伺服器端有效性檢查且身份驗證彈窗已顯示（手機驗證碼模式），**When** 股東輸入正確的 4 碼手機驗證碼且輸入完成（填滿 4 碼），**Then** 系統自動發送驗證並載入該股東的個人資料，無需按確認鍵
4. **Given** QR Code 已通過伺服器端有效性檢查且身份驗證彈窗已顯示（身分證末四碼模式），**When** 股東輸入正確的身分證末四碼（數字）且輸入完成（填滿 4 碼），**Then** 系統自動發送驗證並載入該股東的個人資料，無需按確認鍵
5. **Given** 身份驗證彈窗已顯示（手機驗證碼模式），**When** 股東輸入格式錯誤的驗證碼（非 4 碼數字）或輸入不足 4 碼，**Then** 系統在彈窗內顯示統一錯誤訊息（主要錯誤訊息：「認證失敗，請重新輸入手機驗證碼」、補充說明、聯絡資訊），並清空輸入框以便重新輸入
6. **Given** 身份驗證彈窗已顯示（身分證末四碼模式），**When** 股東輸入格式錯誤的末四碼（非 4 碼數字）或輸入不足 4 碼，**Then** 系統在彈窗內顯示統一錯誤訊息（主要錯誤訊息：「認證失敗，請重新輸入身分證末四碼」、補充說明、聯絡資訊），並清空輸入框以便重新輸入
7. **Given** 身份驗證彈窗已顯示，**When** 股東輸入的驗證碼與 QR Code 不符或驗證碼錯誤，**Then** 系統在彈窗內顯示統一錯誤訊息，輸入框彈跳動畫提示錯誤，並清空輸入內容
8. **Given** 身份驗證彈窗已顯示（手機驗證碼模式），**When** 股東查看 Input OTP 輸入欄位，**Then** 系統顯示 4 個獨立的輸入框（對應手機驗證碼），並在輸入欄位下方顯示說明文字「請輸入手機驗證碼（4 碼數字）」，同時顯示提示訊息「驗證碼已發送至您的手機」
9. **Given** 身份驗證彈窗已顯示（身分證末四碼模式），**When** 股東查看 Input OTP 輸入欄位，**Then** 系統顯示 4 個獨立的輸入框（對應身分證末四碼），並在輸入欄位下方顯示說明文字「請輸入身分證末四碼」
10. **Given** 股東掃描 QR Code，**When** QR Code 無效或已過期，**Then** 系統在**身份驗證彈窗顯示前**即顯示錯誤訊息畫面，並提供聯繫管理員的管道（電話或電子郵件）

---

### User Story 2 - 個人資料顯示與修改 (Priority: P2)

身份驗證成功後，系統顯示股東的個人資料，股東可以修改地址和電話號碼，提交修改後系統保存更新後的資料。

**Why this priority**: 這是功能的核心價值，讓股東能夠自主更新聯絡資訊，確保公司能夠與股東保持正確的聯繫管道。

**Independent Test**: 可以透過身份驗證後，修改地址和電話號碼，驗證系統能夠正確保存並顯示更新後的資料。此流程可獨立完成並提供價值（資料修改功能）。

**Acceptance Scenarios**:

1. **Given** 股東身份驗證成功，**When** 系統載入個人資料，**Then** 顯示歡迎詞（包含股東姓名和遮罩的身分證字號）以及三個可編輯欄位（地址、住家電話、手機電話），欄位預設顯示更新值（如有）或原數據
2. **Given** 個人資料已顯示，**When** 股東點擊「資料確認」按鈕，**Then** 系統直接跳轉到感謝頁面，並在背景異步記錄一次修改次數
3. **Given** 個人資料已顯示，**When** 股東修改任何欄位後點擊「資料確認」按鈕，**Then** 系統直接跳轉到感謝頁面，並在背景異步提交更新資料和記錄修改次數
4. **Given** 個人資料已顯示，**When** 股東未修改任何資料直接點擊「資料確認」按鈕，**Then** 系統直接跳轉到感謝頁面，並在背景異步記錄一次修改次數
5. **Given** 資料確認按鈕已點擊，**When** 系統處理跳轉時，**Then** 立即跳轉到感謝頁面，不等待 API 回應

---

### Edge Cases

- 當 QR Code 無效或已過期時，系統顯示錯誤訊息，並提供聯繫管理員的管道（如電話或電子郵件）
- 當驗證碼（手機驗證碼或身分證末四碼）在系統中不存在或錯誤時，系統顯示錯誤訊息「身份驗證失敗，如持續無法驗證，請聯繫管理員」，並提供聯繫方式
- 當手機驗證碼過期時，系統顯示錯誤訊息「驗證碼已過期，請重新發送驗證碼」，並提供重新發送功能
- 當使用者嘗試在 1 分鐘冷卻時間內重新發送驗證碼時，系統應顯示錯誤訊息「請於 X 秒後再次發送驗證碼」（顯示剩餘秒數）
- 當驗證碼倒數計時器歸零時，系統應自動跳回原介面（顯示手機號碼與操作按鈕），允許用戶重新發送驗證碼
- 當簡訊發送失敗時，系統應自動降級為身分證末四碼驗證模式（如果原本應使用手機驗證碼）
- 當網路連線中斷時，系統應顯示錯誤訊息，提示用戶檢查網路連線後重試
- 當多個股東同時使用相同 QR Code 時，系統應拒絕後續的驗證請求，顯示「QR Code 已被使用」錯誤訊息
- 當股東點擊「資料確認」按鈕時，系統不進行任何驗證，直接跳轉到感謝頁面
- 當資料修改過程中發生系統錯誤時，系統應回滾交易，確保資料一致性，並顯示錯誤訊息提示用戶重試
- 當股東在修改過程中關閉網頁或離開時，系統不保存任何變更，已輸入的資料會遺失（瀏覽器預設行為）
- 當多個股東同時修改同一筆資料，或同一股東在不同裝置上同時修改時，系統採用「最後寫入獲勝」策略，後提交的更新會覆蓋先前的更新
- 當股東點擊「資料確認」按鈕後，系統必須立即跳轉到感謝頁面，不等待 API 回應
- 系統在背景異步調用 API 記錄修改次數，即使 API 調用失敗也不影響頁面跳轉

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統必須能夠解析 QR Code（QR Code 內容為完整 URL，格式：`{protocol}://{host}/shareholder/update/{verification_code}`，其中 `verification_code` 為 7 位數字，由 6 位股東代號 + 1 位檢查碼組成，檢查碼由股東代號各位數字相加取模10計算得出）並導向對應的網頁
- **FR-002**: 系統必須在進入網頁時顯示身份驗證彈窗，彈窗標題顯示「中華工程股份有限公司股東資料回報」，並使用 `logo.png` 作為公司 Logo
- **FR-003**: 系統必須在顯示身份驗證彈窗前，先透過後端 API 檢查 URL 中的 QR Code 驗證碼是否在資料庫存在且有效（例如：檢查 `verification_code` 是否存在且與股東資料一致）。當 QR Code 無效或已過期時，系統不得顯示身份驗證彈窗，而是直接顯示錯誤畫面（包含聯繫管理員資訊）
- **FR-003A**: 系統必須驗證輸入的「身分證末四碼」是否與該 QR Code 對應的股東資料相符，驗證失敗時必須在原本輸入身分證末四碼的彈窗內顯示錯誤資訊，不導向新頁面，以利重新輸入
- **FR-004**: 系統必須在身份驗證成功後載入並顯示該股東的個人資料表單，表單最上方顯示歡迎詞（包含股東姓名和遮罩的身分證字號），表單僅顯示三個可編輯欄位（地址、住家電話、手機電話）
- **FR-004A**: 系統必須在表單欄位中預設顯示更新值（如有），否則顯示原數據。用戶修改的值必須寫入資料庫的更新欄位，不可更動原數據欄位
- **FR-004B**: 系統必須在提交按鈕下方顯示謝詞及資料申明，說明資料僅供公司內部使用
- **FR-004C**: 系統必須實作「預設值」邏輯：對於每個欄位（地址、住家電話、手機電話），如果 `UPDATED_*` 欄位有值則使用 `UPDATED_*` 作為預設值，否則使用 `ORIGINAL_*` 作為預設值
- **FR-004D**: 系統必須在股東點擊「資料確認」按鈕時，比較前端傳送的值與預設值：如果不同則覆蓋 `UPDATED_*` 欄位並記錄修改次數，如果相同則只記錄修改次數而不更動 `UPDATED_*` 欄位。同時，系統必須更新對應的 `testrachel_log` 記錄，記錄是否有資料變更及各欄位的新值
- **FR-005**: 系統必須允許股東修改地址欄位。地址欄位使用 MUI TextField，multiline，3 行
- **FR-006**: 系統必須允許股東使用 MUI TextField 元件修改電話號碼欄位。電話號碼輸入欄位應使用 `type="tel"` 和 `inputMode="numeric"` 屬性，僅允許輸入數字
- **FR-007**: （已移除：不再需要格式驗證）
- **FR-012**: （已移除：不再需要驗證，點擊「資料確認」後直接跳轉並記錄修改次數）
- **FR-008**: 系統必須在股東點擊「資料確認」按鈕時，直接跳轉到感謝頁面，並在背景異步記錄一次修改次數和更新 `testrachel_log` 記錄
- **FR-013**: 系統必須在資料確認後，顯示感謝頁面，頁面包含感謝訊息、成功提示和公司 Logo
- **FR-009**: 系統必須在身份驗證失敗時，統一在原本輸入驗證碼的彈窗內顯示簡化的錯誤資訊，不導向新頁面，以利重新輸入，允許無限次重試，且錯誤時須觸發輸入框彈跳動畫並清空輸入。錯誤訊息統一顯示格式如下：
  - **主要錯誤訊息**（顯著顯示）：「認證失敗，請重新輸入驗證碼」（手機驗證碼模式）或「認證失敗，請重新輸入身分證末四碼」（身分證末四碼模式）
  - **補充說明**：顯示「請確認已掃描信件上的 QR Code，並輸入您的驗證碼」
  - **聯絡資訊**：顯示「若持續無法驗證，請聯絡我們：電話：02-1234-5678 | 電子郵件：admin@example.com」
- **FR-018**: 系統必須在身份驗證彈窗使用 shadcn/ui Input OTP 元件：
  - **手機驗證碼模式**：4 個獨立的輸入框（對應 4 碼數字驗證碼），並在輸入欄位下方顯示說明文字「請輸入手機驗證碼（4 碼數字）」，同時顯示提示訊息「驗證碼已發送至您的手機」
  - **身分證末四碼模式**：4 個獨立的輸入框（對應身分證末四碼），並在輸入欄位下方顯示說明文字「請輸入身分證末四碼」
  - 身份驗證對話框必須自適應大小，禁用滾動功能，並在底部預留空間顯示錯誤訊息，確保所有內容完整呈現且無需滾動
- **FR-028**: 系統必須在身份驗證輸入欄位填滿時自動送出驗證（手機驗證碼模式：4 碼；身分證末四碼模式：4 碼），無需額外按鈕或確認鍵；驗證成功即直接登入並載入個人資料
- **FR-029**: 系統必須根據股東資料中的手機號碼決定驗證方式（優先順序：`UPDATED_MOBILE_PHONE` → `ORIGINAL_MOBILE_PHONE`）。如果股東資料中有最新修改的手機號碼（`UPDATED_MOBILE_PHONE` 欄位不為空），則使用該手機號碼進行驗證碼驗證；如果沒有最新修改的手機號碼，但資料中有原始手機號碼（`ORIGINAL_MOBILE_PHONE` 欄位不為空），則使用原始手機號碼進行驗證碼驗證；如果兩個手機號碼欄位都為空，則使用身分證末四碼驗證
- **FR-030**: 使用手機號碼驗證時，系統必須自動產生 4 位數字驗證碼，並透過簡訊 API 發送至該手機號碼（優先使用最新修改的手機號碼）。驗證碼必須儲存在伺服器端（建議使用 Redis 或資料庫暫存），並設定有效期為 1 分鐘
- **FR-031**: 手機號碼驗證碼必須為 4 位數字，有效期為 1 分鐘。驗證碼過期後必須重新發送。系統必須限制驗證碼重新發送間隔為 1 分鐘，即同一手機號碼在發送驗證碼後，必須等待 1 分鐘才能再次發送
- **FR-032**: 手機號碼驗證時，身份驗證對話框必須顯示提示訊息「驗證碼已發送至您的手機，請輸入驗證碼」，並在輸入欄位下方顯示說明「請輸入手機驗證碼（4 碼數字）」。系統必須在輸入驗證碼介面顯示倒數計時器（顯示剩餘秒數），當驗證碼過期（倒數至 0）時，自動跳回原介面（顯示手機號碼與操作按鈕），允許用戶重新發送驗證碼
- **FR-033**: 系統必須提供簡訊發送功能，使用簡訊服務商 API（例如：e8d.tw）發送驗證碼簡訊。簡訊發送功能實作於 Node.js 模組（例如 `src/lib/sms.js`），由 `/api/shareholder/send-verification-code` API 路由統一對外提供，不再依賴外部 Python 腳本
- **FR-034**: 系統必須在 `testrachel_log` 資料表中記錄每次驗證行為（不論成功或失敗）。當股東掃描 QR Code 進入頁面並進行驗證時，系統必須建立一筆記錄，包含：記錄ID（UUID格式）、股東代號、身分證字號、掃描進入頁面時間（SCAN_TIME）、驗證請求時間（LOGIN_TIME）、驗證類型（手機驗證或身分證驗證）、使用的手機號碼（僅手機驗證時）、手機驗證完成時間（僅手機驗證成功時）、系統產生的原始驗證碼（RANDOM_CODE，僅手機驗證時）、初始狀態 `HAS_UPDATED_DATA = 0`。驗證成功或失敗都會建立 log 記錄。`testrachel_log` 表的主鍵為 `LOG_ID`（UUID），並以 `SHAREHOLDER_CODE` 和 `ID_NUMBER` 作為複合索引
- **FR-035**: 系統必須在股東點擊「資料確認」按鈕且有任何欄位變更時，更新對應的 `testrachel_log` 記錄，設定 `HAS_UPDATED_DATA = 1`，並記錄各欄位的新值（僅記錄有變更的欄位：`UPDATED_ADDRESS`、`UPDATED_HOME_PHONE`、`UPDATED_MOBILE_PHONE`）
- **FR-036**: 系統必須確保每次登入都對應 `testrachel_log` 表中的一筆記錄，用於追蹤完整的操作歷程
- **FR-019**: 系統必須在網頁標題和身份驗證彈窗中顯示「中華工程股份有限公司股東資料回報」，並使用 `logo.png` 作為公司 Logo
- **FR-022**: 系統必須設定頁面的 metadata（頁嵌名稱），主頁面標題為「中華工程股份有限公司股東資料回報」，描述為「中華工程-股東資料更新畫面」；管理頁面標題為「股東資料QR Code列印」，描述為「中華工程-股東資料QR Code列印畫面」
- **FR-010**: 系統必須防止未通過身份驗證的用戶存取個人資料
- **FR-011**: 系統必須確保每次 QR Code 掃描只能對應單一股東身份
- **FR-014**: 系統必須在 QR Code 無效或已過期時，於身份驗證彈窗顯示前即顯示錯誤訊息畫面，並提供聯繫管理員的管道（電話或電子郵件）
- **FR-015**: 系統必須支援產生 QR Code（標準解析度 300px 寬度，適合螢幕顯示和一般用途）
- **FR-016**: 系統必須支援在頁面載入時自動批次產生當前分頁顯示的股東 QR Code，方便管理員快速查看
- **FR-017**: QR Code 必須使用固定的生產環境 URL（透過環境變數 `NEXT_PUBLIC_QRCODE_BASE_URL` 設定），確保 QR Code 內容固定且長期有效
- **FR-020**: 系統必須提供管理頁面，管理頁面使用 MUI X Data Grid 展現股東列表，提供篩選功能，並在頁面載入時自動為當前分頁顯示的股東產生並顯示 QR Code 圖片
- **FR-020A**: 管理頁面表格必須顯示以下欄位：股東代號（URL連結）、姓名、身分證字號、原始地址、更新地址、原始家用電話、更新家用電話、原始手機號碼、更新手機號碼、登入次數、修改次數、QR Code（含下載按鈕）
- **FR-020B**: QR Code 圖片必須永遠保持正方形，使用 `object-fit: contain` 和固定寬高比 `aspect-ratio: 1 / 1`，圖片容器固定為 80px × 80px
- **FR-027**: 管理頁面目前暫定為完全公開存取，無需身份驗證（未來可能會調整為需要基本身份驗證）
- **FR-021**: 管理頁面輸入股東識別碼時，只需輸入 6 位股東代號，系統會根據股東代號查詢資料庫中已儲存的 `verification_code`（7位數字：6位股東代號+1位檢查碼）作為 QR Code URL。`verification_code` 在股東資料建立時就已根據檢查碼規則（股東代號各位數字相加取模10）計算並儲存於資料庫中
- **FR-023**: 管理頁面載入時，系統必須自動批次產生當前分頁顯示的股東 QR Code，無需額外的「產生 QR Code」按鈕操作。當分頁變更時，自動為新分頁的股東產生 QR Code
- **FR-024**: 管理頁面表格中的 URL 欄位必須顯示 7 位驗證碼（`verification_code`），並以完整 URL 路徑的超連結形式呈現，點擊後可開啟對應的股東資料修正頁面。URL 格式：`{protocol}://{host}/shareholder/update/{verification_code}`
- **FR-025**: 管理頁面表格中必須直接顯示 QR Code 圖片，每個 QR Code 旁提供個別下載按鈕，方便管理員快速下載單一 QR Code
- **FR-026**: 管理頁面必須提供「匯出所有資料」功能，匯出時必須包含所有股東資料（不受分頁限制）。匯出時系統必須為所有股東產生 QR Code（使用批次產生 API，傳入所有股東代號），匯出的 Excel 檔案應包含：股東代號、身分證字號、姓名、原始地址、更新地址、原始家用電話、更新家用電話、原始手機號碼、更新手機號碼、登入次數、修改次數、UUID、完整 URL、QR Code 圖片等欄位

### Key Entities _(include if feature involves data)_

- **股東 (Shareholder)**: 代表系統中的股東個體，包含股東代號（6位數字，唯一識別碼）、身分證字號、出生年月日、姓名、通訊地址、電話號碼等基本資料。儲存於 `testrachel` 資料表，記錄原始數據和最後更新的數據以及登入和修改總數
- **QR Code 驗證碼**: 由股東代號（6位數字）透過可計算規則生成的7位數字驗證碼，計算規則為：將股東代號的各位數字相加，取模10得到檢查碼，組成格式為「6位股東代號+1位檢查碼」。驗證碼在股東資料建立時就計算並儲存於資料庫的 `verification_code` 欄位中，確保資料一致性。QR Code 包含完整 URL（格式：`{protocol}://{host}/shareholder/update/{verification_code}`），用於快速進入資料修正頁面。QR Code 內容為完整 URL 而非相對路徑，確保從紙本掃描時可以正確開啟網頁
- **股東操作記錄 (Shareholder Log)**: 記錄股東每次驗證行為和資料修改操作的完整歷程。儲存於 `testrachel_log` 資料表，包含記錄ID（UUID格式）、股東代號、身分證字號、掃描進入頁面時間（SCAN_TIME）、驗證請求時間（LOGIN_TIME）、驗證類型（手機驗證或身分證驗證）、使用的手機號碼（僅手機驗證時）、手機驗證完成時間（僅手機驗證成功時）、系統產生的原始驗證碼（RANDOM_CODE，僅手機驗證時）、是否更新資料、各可更新欄位的新值等資訊。每次驗證嘗試（成功或失敗）都對應一筆記錄，用於追蹤完整的操作歷程。表的主鍵為 `LOG_ID`（UUID），並以 `SHAREHOLDER_CODE` 和 `ID_NUMBER` 作為複合索引

## UI/UX Design Requirements

### Design System Overview

- **主要 UI 元件庫**: Material-UI (MUI) v7.3.2
- **輔助 UI 元件庫**: shadcn/ui (New York 風格) - 用於 Input OTP 元件（僅用於身分證末四碼輸入）
- **樣式系統**: Tailwind CSS + CSS Variables
- **設計原則**: 遵循 Material Design 3.0，確保一致性和無障礙設計

### Color System (顏色系統)

#### Primary Colors

- **Primary**: `hsl(222.2, 47.4%, 11.2%)` - 主要按鈕、連結
- **Primary Foreground**: `hsl(210, 40%, 98%)` - 主色調上的文字
- **Secondary**: `hsl(210, 40%, 96.1%)` - 次要按鈕、背景

#### Semantic Colors

- **Success**: MUI 預設綠色 - 成功訊息
- **Error/Destructive**: `hsl(0, 84.2%, 60.2%)` - 錯誤訊息、刪除操作
- **Warning**: MUI 預設橙色 - 警告訊息
- **Info**: MUI 預設藍色 - 資訊訊息

#### Neutral Colors

- **Background**: `hsl(0, 0%, 100%)` (淺色) / `hsl(222.2, 84%, 4.9%)` (深色)
- **Foreground**: `hsl(222.2, 84%, 4.9%)` (淺色) / `hsl(210, 40%, 98%)` (深色)
- **Border**: `hsl(214.3, 31.8%, 91.4%)` (淺色) / `hsl(217.2, 32.6%, 17.5%)` (深色)
- **Muted**: `hsl(210, 40%, 96.1%)` - 次要背景、禁用狀態

### Typography (字體系統)

- **字體**: Roboto (`@fontsource/roboto`)
- **標題**: h1 (40px) → h6 (16px)，使用 Medium 或 Bold 字重
- **內文**: body1 (16px) - 主要內文，body2 (14px) - 次要內文
- **說明文字**: caption (12px) - 標籤、註解
- **按鈕文字**: 14px，Medium 字重

### Spacing System (間距系統)

- **Base Unit**: 8px
- **常用間距**: xs (4px), sm (8px), md (16px), lg (24px), xl (32px)
- **表單欄位間距**: md (16px)
- **對話框內容 padding**: lg (24px)
- **頁面邊距**: lg 或 xl (24-32px)

### Component Specifications (元件規範)

#### Buttons (按鈕)

- **Contained** (主要): Primary 顏色，用於提交、確認
- **Outlined** (次要): Primary 邊框，用於取消
- **Text** (文字): 無背景，用於輔助操作
- **尺寸**: Large (42px), Medium (36px), Small (30px)
- **狀態**: Hover 顏色加深 10%，Disabled 透明度 0.38，Loading 顯示 CircularProgress

#### Text Fields (輸入欄位)

- **樣式**: Outlined variant（預設）
- **高度**: 56px（含標籤）
- **標籤**: 位於輸入框上方，body2 字體大小
- **輔助文字**: 位於輸入框下方，caption 字體大小，Muted Foreground 顏色
- **錯誤狀態**: 邊框和標籤變為 Error 顏色，顯示錯誤訊息
- **Focus**: 邊框顏色 Primary，寬度 2px

#### Input OTP (一次性密碼輸入)

- **元件**: shadcn/ui Input OTP (`@/components/ui/input-otp`)
- **使用場景**:
  - **僅用於**身份驗證彈窗：身分證末四碼輸入（4 碼數字）
- **配置**:
  - **身分證末四碼**: `maxLength={4}`，僅允許數字（0-9），阻擋非數字輸入
  - **輸入驗證**: 在 `onChange` 事件中進行自定義驗證與過濾，確保只接受 4 碼數字，少於 4 碼不觸發驗證
- **佈局**:
  - **身分證末四碼**: 4 個 InputOTPSlot（不需要分隔符），輸入滿 4 碼即自動送出驗證
- **樣式**:
  - 每個 Slot 寬度一致，高度與 TextField 一致（56px）
  - Focus 狀態：邊框顏色 Primary，寬度 2px
  - 錯誤狀態：邊框顏色 Error/Destructive
  - 支援自動焦點移動：輸入完成後自動移至下一個欄位
- **互動**:
  - 支援貼上功能：可一次性貼上完整號碼
  - 支援退格鍵：刪除當前欄位並返回上一個欄位
  - 支援鍵盤導航：方向鍵可在欄位間移動
- **無障礙**:
  - 每個 Slot 有對應的 label
  - 錯誤訊息與整個 Input OTP 組件關聯
  - 支援螢幕閱讀器讀取

#### Dialogs (對話框)

- **最大寬度**: 600px（行動裝置：全寬減去 32px）
- **圓角**: 4px
- **背景**: Card 顏色，半透明遮罩 (rgba(0, 0, 0, 0.5))
- **標題**: h6 字體大小，Medium 字重，padding lg
- **內容**: padding lg，**不可滾動**（禁用滾動條）
- **操作區**: padding md，按鈕右對齊
- **身份驗證對話框特殊規範**:
  - **自適應大小**: 對話框高度應根據內容自動調整，確保所有內容完整顯示
  - **禁用滾動**: 對話框內容區域必須禁用滾動功能（`overflow: hidden`），上下滾動條都不應出現
  - **錯誤訊息空間**: 必須在對話框底部預留足夠空間（至少 80px）用於顯示錯誤訊息（Alert 組件）
  - **內容完整呈現**: 即使在不同螢幕尺寸下，對話框內容（標題、Logo、輸入欄位、錯誤訊息、按鈕）都必須完整顯示，不得被裁切或需要滾動才能查看
  - **響應式設計**: 在行動裝置上，對話框應自動調整高度和間距，確保內容完整且無需滾動

#### 感謝頁面 (Thank You Page)

- **路由**: `/shareholder/update/[qrCode]/thank-you` 或使用查詢參數 `/shareholder/update/[qrCode]?success=true`
- **觸發時機**: 資料修改成功提交後自動跳轉
- **頁面內容**:
  - **標題**: 「感謝您的配合」
  - **主要訊息**: 「您的資料已成功更新，感謝您的配合與協助。」
  - **成功圖示**: 顯示成功圖示（CheckCircle 或類似圖示）
  - **公司 Logo**: 顯示 `logo.png` 和公司名稱「中華工程股份有限公司」
  - **說明文字**: 「本系統所收集之資料僅供公司內部使用，我們將妥善保管您的個人資料，並遵循相關隱私保護法規。」
- **樣式規範**:
  - **佈局**: 置中對齊，最大寬度 600px
  - **間距**: 上下 padding lg (24px)，左右 padding md (16px)
  - **標題**: Typography variant="h4"，字體大小 24px，Bold 字重 (700)，Primary 顏色
  - **主要訊息**: Typography variant="body1"，字體大小 16px，行高 1.6，text.primary 顏色
  - **成功圖示**: 尺寸 64px × 64px，Success 顏色（綠色）
  - **Logo**: 尺寸 48px × 48px，與公司名稱並排顯示
- **響應式設計**: 行動裝置上自動調整間距和字體大小

#### Paper (紙張容器)

- **元件**: MUI Paper
- **使用場景**: 管理頁面表格容器、表單卡片容器
- **Elevation**: 1（輕微陰影，用於表格容器）
- **圓角**: 預設圓角（MUI 預設）
- **背景**: Card 顏色（白色或主題背景色）
- **管理頁面表格容器規範**:
  - **Padding**: lg (24px) - 容器內側間距
  - **Margin**: 下方 marginBottom lg (24px) - 與下方元素間距
  - **寬度**: 100%（填滿父容器寬度）
  - **高度**: 自適應（根據內容自動調整）
  - **內容結構**:
    - **第一行（標題區域）**: 「股東列表」標題，獨立一行顯示，`marginBottom` md (16px)
      - 標題：「股東列表」，Typography variant="h6"，字體大小 20px，Bold 字重 (700)，顏色 Primary
      - 使用 `display="block"` 或獨立 Box，確保標題突出顯示
    - **第二行（操作區域）**: 搜尋欄位與匯出按鈕並排顯示，使用 flexbox 佈局，`justifyContent="space-between"`，`alignItems="center"`，`marginBottom` md (16px)
      - 搜尋欄位：TextField，`width` 280px（固定寬度，不超過標題寬度），variant="outlined"，placeholder：「請輸入搜尋關鍵字」，左側顯示 Search 圖示
      - 按鈕：「匯出所有資料」，右側對齊，size="medium"，variant="contained"
    - **第三行（表格區域）**: MUI X Data Grid

#### Tables (表格)

- **元件**: MUI X Data Grid (`@mui/x-data-grid`)
- **容器**: 使用 MUI Paper 作為外層容器，elevation 1
- **表頭**: Muted 背景，body2 字體大小，Medium 字重，高度 56px
- **表體**: Card 背景，最小行高 52px，懸停時背景變為 Muted
- **儲存格**: padding 水平 16px、垂直 8px，body2 字體大小
- **分頁**: 表格內建分頁控制，每頁選項 [5, 10, 25, 50]
- **空狀態**: 顯示「找不到符合條件的股東」
- **響應式**: Data Grid 自動處理響應式佈局
- **管理頁面表格特殊規範**:
  - **標題區域（第一行）**:
    - **佈局**: 獨立一行顯示，`display="block"`，`marginBottom` md (16px)
    - **標題文字**: 「股東列表」，Typography variant="h6"，字體大小 20px，Bold 字重 (700)，顏色 Primary
    - **視覺層次**: 標題應該突出顯示，作為頁面區塊的主要標識
  - **操作區域（第二行）**:
    - **佈局**: 使用 flexbox，`display="flex"`，`justifyContent="space-between"`，`alignItems="center"`，`marginBottom` md (16px)
    - **搜尋欄位**: TextField，`width` 280px（固定寬度，確保不超過標題寬度），variant="outlined"，placeholder：「請輸入搜尋關鍵字」，左側顯示 Search 圖示（InputAdornment）
    - **按鈕**: 「匯出所有資料」，`flex="0 0 auto"`（不擴展），右側對齊，size="medium"，variant="contained"
    - **響應式**: 行動裝置（< 600px）時，搜尋欄位和按鈕垂直排列（`flexDirection="column"`），搜尋欄位全寬
  - **表格內容**:
    - **欄位順序**：股東代號（URL連結）、姓名、身分證字號、原始地址、更新地址、原始家用電話、更新家用電話、原始手機號碼、更新手機號碼、登入次數、修改次數、QR Code（含下載按鈕）
    - **股東代號欄位**：顯示為可點擊的連結，點擊後開啟新分頁導向股東資料修正頁面（格式：`/shareholder/update/{uuid}`）
    - **QR Code 欄位**：
      - QR Code 圖片尺寸：80px × 80px，永遠保持正方形（使用 `object-fit: contain` 和固定寬高比 `aspect-ratio: 1 / 1`）
      - 圖片容器：寬高固定為 80px × 80px，背景色 `#f5f5f5`，圓角 4px
      - 下載按鈕：位於 QR Code 圖片旁，Small 尺寸，Outlined variant，顯示 Download 圖示
    - **地址和電話欄位**：顯示原始值和更新值，如果值為空則顯示「-」
    - **數字欄位**：登入次數和修改次數顯示為數字類型，預設值為 0

#### Alerts (訊息提示)

- **Error**: 紅色背景，用於錯誤訊息
- **Success**: 綠色背景，用於成功訊息
- **Warning**: 橙色背景，用於警告訊息
- **Info**: 藍色背景，用於資訊訊息
- **邊距**: 上下 16px
- **圓角**: 4px
- **圖示**: 左側顯示對應圖示

### Responsive Design (響應式設計)

- **行動裝置** (< 600px): 對話框全寬減去 32px，按鈕全寬垂直排列，表格水平滾動
- **平板** (600px - 1200px): 對話框最大寬度 600px 居中，表格全寬顯示
- **桌面** (> 1200px): 對話框最大寬度 600px 居中，保持緊湊佈局

### Accessibility (無障礙設計)

- **對比度**: 文字與背景對比度至少 4.5:1 (WCAG AA)
- **鍵盤導航**: 所有互動元素可透過鍵盤操作，Tab 順序符合邏輯
- **焦點狀態**: 2px 實線邊框，Primary 顏色
- **螢幕閱讀器**: 表單欄位有對應 label，錯誤訊息與輸入欄位關聯

### Logo & Branding (品牌識別)

- **Logo 檔案**: `logo.png`
- **顯示位置**: 身份驗證對話框標題區域、導覽列
- **尺寸**: 對話框高度 40px，導覽列高度 48px
- **公司名稱**: 「中華工程股份有限公司股東資料回報」，h5 字體大小 (20px)，Medium 字重

### Navigation Bar (導覽列)

#### 主頁面導覽列（股東資料修正頁面）

- **元件**: MUI AppBar + Toolbar
- **位置**: `position="static"`（不固定導覽列，隨頁面滾動）
- **高度**: 64px（Toolbar 預設高度）
- **背景**: 使用 MUI 預設 AppBar 背景色（白色或主題背景色）
- **Elevation**: 4（輕微陰影，表示浮動效果）
- **內容結構**:
  - **Logo**: 左側顯示，尺寸 48px × 48px，與標題之間 gap 為 md (16px)
  - **標題文字**: 「中華工程股份有限公司股東資料回報」，Typography variant="h5"，字體大小 20px，Medium 字重 (500)，左對齊
  - **佈局**: 使用 Toolbar，`display="flex"`、`alignItems="center"`、`gap={2}` (16px)
- **樣式規範**:
  - 字體大小：20px（h5）
  - 字重：500（Medium）
  - 顏色：使用 MUI 預設文字顏色（Foreground）
  - 對齊：左對齊（與 Logo 對齊）
- **響應式**: 行動裝置時，標題文字自動換行或縮小字體

#### 管理頁面導覽列（QR Code 列印頁面）

- **元件**: MUI AppBar + Toolbar
- **位置**: `position="static"`（不固定導覽列，隨頁面滾動）
- **高度**: 64px（Toolbar 預設高度）
- **背景**: 使用 MUI 預設 AppBar 背景色（白色或主題背景色）
- **Elevation**: 4（輕微陰影，表示浮動效果）
- **內容結構**:
  - **Logo**: 左側顯示，尺寸 48px × 48px，與標題之間 gap 為 md (16px)
  - **標題文字**: 「股東資料QR Code列印」，Typography variant="h5"，字體大小 20px，Medium 字重 (500)，左對齊
  - **佈局**: 使用 Toolbar，`display="flex"`、`alignItems="center"`、`gap={2}` (16px)
- **樣式規範**:
  - 字體大小：20px（h5）
  - 字重：500（Medium）
  - 顏色：使用 MUI 預設文字顏色（Foreground）
  - 對齊：左對齊（與 Logo 對齊）
- **響應式**: 行動裝置時，標題文字自動換行或縮小字體

#### 資料修改表單 (DataForm)

- **歡迎詞區塊**:

  - **位置**: 表單最上方，Card 內容區域的第一個元素
  - **內容**: 「股東 {股東姓名} 您好，身分證字號 {遮罩的身分證字號} ，請協助確認一下資料。」
  - **身分證字號遮罩規則**: 只顯示英文字母（第一個字元）+ 後面四碼，中間用 `******` 遮住
    - 範例：`A123456789` → `A******6789`
  - **Typography**: body1 字體大小 (16px)，字重 400，行高 1.6
  - **間距**: 下方 marginBottom 為 lg (24px)

- **表單欄位**:

  - **顯示欄位**: 僅顯示三個可編輯欄位（地址、住家電話、手機電話）
  - **預設值定義**:
    - 對於每個欄位，系統必須判斷 `UPDATED_*` 欄位是否有值
    - 如果 `UPDATED_*` 有值（不為 NULL 且不為空字串），則預設值 = `UPDATED_*`
    - 如果 `UPDATED_*` 沒有值（NULL 或空字串），則預設值 = `ORIGINAL_*`
    - 表單初始化時，每個欄位顯示對應的預設值
  - **資料確認邏輯**:
    - 當股東點擊「資料確認」按鈕時，系統必須比較前端傳送的值與預設值（每個欄位獨立處理）
    - **如果前端值 ≠ 預設值**：
      - 覆蓋 `UPDATED_*` 欄位 = 前端值
      - `UPDATE_COUNT = UPDATE_COUNT + 1`
      - 更新 `testrachel_log` 記錄：設定 `HAS_UPDATED_DATA = 1`，並記錄有變更的欄位新值
    - **如果前端值 = 預設值**：
      - `UPDATED_*` 欄位保持不變（不覆蓋）
      - `UPDATE_COUNT = UPDATE_COUNT + 1`
      - 更新 `testrachel_log` 記錄：保持 `HAS_UPDATED_DATA = 0`（或設定為 0）
    - 無論是否有變更，都必須記錄一次修改次數（`UPDATE_COUNT + 1`）和更新 `testrachel_log` 記錄
    - `ORIGINAL_*` 欄位永遠不可更動
  - **地址欄位**:
    - **標籤**: 「地址」
    - **必填**: 是
    - **元件**: MUI TextField，multiline，3 行
    - **驗證**: 必須驗證格式
  - **住家電話欄位**:
    - **標籤**: 「住家電話」
    - **必填**: 否（可選）
    - **元件**: MUI TextField，`type="tel"`，`inputMode="tel"`
    - **驗證**: 如果填寫，必須驗證格式
  - **手機電話欄位**:
    - **標籤**: 「手機電話」
    - **必填**: 否（可選）
    - **元件**: MUI TextField，`type="tel"`，`inputMode="numeric"`，`maxLength={10}`
    - **驗證**: 如果填寫，必須驗證格式（10 位數字）

- **提交按鈕**:

  - **位置**: 表單欄位下方
  - **文字**: 「資料確認」
  - **樣式**: Contained variant，Large 尺寸 (42px)
  - **行為**: 點擊後直接跳轉到感謝頁面，不顯示載入狀態，背景異步記錄修改次數
  - **間距**: 上方 marginTop 為 md (16px)

- **謝詞及資料申明區塊**:
  - **位置**: 提交按鈕下方
  - **內容**: 「感謝您的配合與協助。本系統所收集之資料僅供公司內部使用，我們將妥善保管您的個人資料，並遵循相關隱私保護法規。」
  - **樣式**:
    - Typography: body2 字體大小 (12px)，行高 1.6，顏色 text.secondary
    - 上方有分隔線（borderTop: 1px solid divider）
    - 置中對齊
  - **間距**: 上方 marginTop 為 md (16px)，上方 paddingTop 為 md (16px)

### Error Handling UI (錯誤處理)

- **顯示位置**: 輸入欄位正下方
- **樣式**: Error Alert 或紅色文字 (body2)
- **錯誤類型**:
  - **身份驗證錯誤**（統一格式）：
    - 主要錯誤訊息（顯著顯示）：「認證失敗，請重新輸入身分證末四碼」
    - 補充說明：「請確認已掃描信件上的 QR Code，並輸入您的身分證末四碼」
    - 聯絡資訊：「若持續無法驗證，請聯絡我們：電話：02-1234-5678 | 電子郵件：admin@example.com」
  - **資料修改錯誤**：
    - 必填欄位：「此欄位為必填」
    - 電話號碼格式錯誤：「請輸入正確的電話號碼格式（10 位數字）」
- **恢復**: 錯誤訊息顯示在原本對話框內，不導向新頁面，允許無限次重試

### Loading & Success States (載入與成功狀態)

- **載入指示器**: 不需要載入狀態，點擊「資料確認」按鈕後立即跳轉
- **跳轉行為**: 點擊按鈕後立即跳轉到感謝頁面，不顯示載入動畫
- **背景處理**: 系統在背景異步調用 API 記錄修改次數，不影響頁面跳轉
- **錯誤處理**: API 調用失敗時靜默處理，不影響用戶體驗

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 股東能夠在 30 秒內完成從掃描 QR Code 到身份驗證成功的完整流程
- **SC-002**: 95% 的股東能夠在第一次嘗試時成功完成身份驗證
- **SC-003**: 股東能夠在 1 分鐘內完成資料確認並跳轉到感謝頁面
- **SC-004**: 系統能夠正確處理並保存 99% 的資料修改請求
- **SC-005**: 身份驗證失敗時，系統在 1 秒內顯示錯誤訊息
- **SC-006**: 點擊「資料確認」按鈕後，系統在 1 秒內跳轉到感謝頁面
- **SC-007**: 90% 的股東能夠獨立完成整個資料修正流程，無需額外協助
- **SC-008**: 系統能夠在 3 秒內產生單一 QR Code（標準解析度）
- **SC-009**: 系統能夠在 20 秒內批次產生 100 個 QR Code
- **SC-010**: 系統能夠在 5 秒內匯出包含所有股東資料的 Excel 檔案（適用於 1000-10000 筆資料規模）
- **SC-011**: 管理頁面在載入 1000 筆股東資料時，初始載入時間應在 3 秒內完成
- **SC-012**: 管理頁面分頁切換時，QR Code 產生時間應在 2 秒內完成（每頁 10-50 筆）

## Clarifications

### Session 2025-12-18

- Q: 管理頁面（`/shareholder/qrcode-batch`）是否需要身份驗證或授權機制？ → A: 目前暫定完全公開，無需任何身份驗證（選項 A），未來可能會調整為需要基本身份驗證（選項 B）
- Q: Excel 匯出時是否需要包含 QR Code 圖片？ → A: 暫定包含 QR Code 圖片（每個股東的 QR Code 嵌入 Excel 儲存格）
- Q: 管理頁面載入時，是否需要為所有股東產生 QR Code，還是僅為當前分頁的股東產生？ → A: 僅為當前分頁顯示的股東產生 QR Code（分頁載入）
- Q: 當多個股東同時修改同一筆資料，或同一股東在不同裝置上同時修改時，系統應如何處理？ → A: 最後寫入獲勝（Last Write Wins）- 後提交的更新覆蓋先前的更新
- Q: 管理頁面需要處理的股東數量預期範圍為何？ → A: 1000-10000 筆（大型公司）
- Q: 當股東輸入錯誤的身分證末四碼時，系統應該允許多少次失敗嘗試？是否需要防止暴力破解攻擊？ → A: 無限制，允許無限次重試
- Q: 當股東修改個人資料時，地址和電話號碼欄位是否都必須填寫？還是可以留空？ → A: 兩者都是必填，不允許空值
- Q: 當股東修改地址或電話號碼並點擊提交後，系統是否需要在保存前顯示確認對話框？ → A: 不需要確認對話框，點擊「資料確認」按鈕後直接跳轉到感謝頁面，並在背景記錄修改次數
- Q: 當股東掃描的 QR Code 無效（格式錯誤）或已過期時，系統應該如何處理？是否需要提供替代方案？ → A: 顯示錯誤訊息，並提供聯繫管理員的管道（如電話或電子郵件）
- Q: 當股東輸入的身分證末四碼在系統中不存在或打錯時，系統應該如何回應？錯誤訊息應該如何呈現？ → A: 在原本輸入身分證末四碼的彈窗內重點顯示「請確認身分證末四碼」錯誤資訊，並用提示方式簡單顯示「請聯絡我們」的資訊，不導向新頁面，以利重新輸入
- Q: 身份驗證錯誤時是否應該導向新頁面？ → A: 否，所有錯誤資訊都應在原本輸入身分證末四碼的彈窗內顯示，不導向新頁面，以利重新輸入
- Q: QR Code 驗證碼的格式為何？ → A: 6 位股東代號 + 1 位檢查碼，共 7 位數字。檢查碼由股東代號各位數字相加取模10計算得出（例如：股東代號 `123456` → 檢查碼 `1` → 驗證碼 `1234561`）
- Q: 網頁標題和 Logo 應如何顯示？ → A: 使用 `logo.png` 作為公司 Logo，標題顯示「中華工程股份有限公司股東資料回報」

## Assumptions

- QR Code 由系統預先產生並分發給各股東
- QR Code 內容為完整 URL（格式：`{protocol}://{host}/shareholder/update/{verification_code}`），而非相對路徑
- 驗證碼由股東代號計算生成，計算規則：股東代號各位數字相加取模10得到檢查碼
- 系統會自動從請求中取得 base URL，如果 host 為 `0.0.0.0`，會自動替換為 `localhost` 以方便掃描
- 每個 QR Code 對應單一股東，且包含該股東的識別資訊
- 股東資料已預先存在於系統中，包含股東代號（唯一識別碼）、身分證字號、出生年月日、姓名、通訊地址、電話號碼等基本資料
- 系統預期需要處理 1000-10000 筆股東資料（大型公司規模），管理頁面設計需考慮此資料量級的效能表現
- 股東使用具備 QR Code 掃描功能的行動裝置（智慧型手機或平板）
- 股東具備基本的數位操作能力
- 系統具備穩定的網路連線環境
- 電話號碼格式遵循台灣地區的電話號碼規範（10 位數字），使用 MUI TextField 元件輸入，設定 `type="tel"` 和 `inputMode="numeric"` 僅允許數字
- 地址欄位支援繁體中文輸入
- 身份驗證允許無限次重試，不設失敗次數限制
- 點擊「資料確認」按鈕後，系統不進行任何驗證，直接跳轉到感謝頁面，並在背景記錄修改次數
- 資料確認時，點擊「資料確認」按鈕後直接跳轉到感謝頁面，並在背景異步記錄修改次數
- QR Code 無效或已過期時，系統顯示錯誤訊息並提供聯繫管理員的管道
- 身分證末四碼不存在時，系統顯示錯誤訊息「身份驗證失敗，如持續無法驗證，請聯繫管理員」，並提供聯繫方式
- QR Code 用於紙本印刷時，必須使用固定的生產環境 URL，確保印刷後長期有效
- 批次產生 QR Code 時，系統應提供下載功能，方便管理員進行大量印刷作業
- 股東代號為 6 位數字（例如：`123456`），是系統的唯一識別碼
- QR Code 驗證碼格式為：6 位股東代號 + 1 位檢查碼（共 7 位數字，例如：`1234561`），檢查碼由股東代號各位數字相加取模10計算得出
- 管理頁面輸入時只需輸入 6 位股東代號，系統會根據股東代號查詢資料庫中已儲存的 `verification_code`（7位數字：6位股東代號+1位檢查碼）作為 QR Code URL。`verification_code` 在資料建立時就已計算並儲存
- 身份驗證錯誤時，所有錯誤資訊都必須在原本輸入身分證末四碼的彈窗內顯示，不導向新頁面，以利重新輸入
- 網頁標題顯示「中華工程股份有限公司股東資料回報」，並使用 `logo.png` 作為公司 Logo
